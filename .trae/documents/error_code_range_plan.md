# 错误代码范围处理实现计划

## 项目背景
当前 `PlayerProcessor.kt` 文件中已经实现了基于错误代码范围的错误处理逻辑，但需要确保它与新添加的 HTTP 错误处理逻辑一样完善和可靠。

## 当前实现分析

### 现有代码
```kotlin
// 使用错误代码的范围和分类逻辑进行判断，提高兼容性
return when {
    // 网络错误范围 (1000-1099)
    error.errorCode in 1000..1099 -> "网络错误，请检查网络连接"
    // 解码错误范围 (1100-1199)
    error.errorCode in 1100..1199 -> "视频解码错误"
    // 其他常见错误
    error.errorCode == 2000 -> "播放格式不支持"
    error.errorCode == 3000 -> "播放器初始化失败"
    error.errorCode == 2004 -> "播放源错误"
    else -> "播放错误: ${error.errorCode}"
}
```

### 存在的问题
1. **错误代码范围定义不明确**：缺少对错误代码范围的详细说明和验证
2. **错误信息不够具体**：相同范围内的错误使用相同的错误信息
3. **缺少错误代码映射表**：没有集中管理错误代码和对应的错误信息
4. **缺少测试覆盖**：没有针对不同错误代码的测试

## 实现计划

### [x] 任务 1：创建错误代码管理工具类
- **Priority**: P0
- **Depends On**: None
- **Description**:
  - 创建 `ErrorCodeManager.kt` 工具类
  - 定义错误代码范围常量和映射关系
  - 提供错误代码分类和错误信息生成方法
- **Success Criteria**:
  - 错误代码管理工具类创建完成
  - 包含完整的错误代码范围定义
  - 提供清晰的错误信息生成方法
- **Test Requirements**:
  - `programmatic` TR-1.1: 工具类编译通过，无语法错误
  - `human-judgement` TR-1.2: 代码结构清晰，注释完整
- **Notes**: 确保工具类设计为可扩展的，便于后续添加新的错误代码范围

### [x] 任务 2：重构错误代码范围处理逻辑
- **Priority**: P0
- **Depends On**: 任务 1
- **Description**:
  - 修改 `buildErrorMessage` 方法中的错误代码范围处理逻辑
  - 使用新创建的 `ErrorCodeManager` 工具类
  - 提高错误信息的准确性和具体性
- **Success Criteria**:
  - 错误代码范围处理逻辑重构完成
  - 与 HTTP 错误处理逻辑保持一致的代码风格
  - 错误信息更加具体和用户友好
- **Test Requirements**:
  - `programmatic` TR-2.1: 代码编译通过，无语法错误
  - `programmatic` TR-2.2: 不同错误代码范围能返回正确的错误信息
  - `human-judgement` TR-2.3: 代码可读性好，逻辑清晰
- **Notes**: 确保重构后的代码与现有的 HTTP 错误处理逻辑保持一致性

### [x] 任务 3：添加错误代码测试用例
- **Priority**: P1
- **Depends On**: 任务 2
- **Description**:
  - 创建针对错误代码范围处理的测试用例
  - 测试不同错误代码范围的处理逻辑
  - 验证错误信息的准确性
- **Success Criteria**:
  - 测试用例创建完成
  - 覆盖主要的错误代码范围
  - 测试通过，验证错误处理逻辑的正确性
- **Test Requirements**:
  - `programmatic` TR-3.1: 测试用例编译通过
  - `programmatic` TR-3.2: 所有测试用例执行通过
  - `human-judgement` TR-3.3: 测试覆盖全面，包含边界情况
- **Notes**: 测试用例应包括正常情况和边界情况

### [x] 任务 4：优化错误信息国际化支持
- **Priority**: P2
- **Depends On**: 任务 2
- **Description**:
  - 为错误信息添加国际化支持
  - 确保错误信息可以根据不同语言环境显示
- **Success Criteria**:
  - 国际化支持实现完成
  - 错误信息可以在不同语言环境下正确显示
- **Test Requirements**:
  - `programmatic` TR-4.1: 国际化代码编译通过
  - `human-judgement` TR-4.2: 错误信息在不同语言环境下显示正确
- **Notes**: 考虑使用 Android 的字符串资源系统实现国际化

### [x] 任务 5：文档和注释完善
- **Priority**: P2
- **Depends On**: 任务 2
- **Description**:
  - 完善错误代码处理逻辑的文档和注释
  - 说明错误代码范围的定义依据
  - 提供错误处理流程的说明
- **Success Criteria**:
  - 文档和注释完善完成
  - 代码注释清晰，便于理解和维护
  - 包含错误代码处理的完整说明
- **Test Requirements**:
  - `human-judgement` TR-5.1: 代码注释完整，说明充分
  - `human-judgement` TR-5.2: 文档清晰，便于后续维护
- **Notes**: 确保文档与实际代码保持一致

## 预期成果

1. **更完善的错误代码处理系统**：错误代码范围处理与 HTTP 错误处理逻辑同样完善
2. **更具体的错误信息**：用户可以看到更准确的错误原因
3. **更好的可维护性**：错误代码管理集中化，便于后续扩展
4. **更全面的测试覆盖**：确保错误处理逻辑的正确性
5. **更好的国际化支持**：错误信息可以适应不同语言环境

## 风险评估

1. **错误代码范围定义风险**：不同 Media3 版本的错误代码范围可能不同
2. **测试覆盖风险**：难以模拟所有可能的错误代码场景
3. **国际化实现风险**：需要确保所有错误信息都有对应的翻译

## 依赖关系

- 依赖 Media3 库的错误代码系统
- 依赖 Android 的字符串资源系统（用于国际化）
- 依赖现有的 HTTP 错误处理逻辑（用于保持一致性）